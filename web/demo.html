<!doctype html>
<!--  vim: set sw=2 ts=2 et : --> 
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Hypnotic: Let JavaScript Sleep()!</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="demo.css">
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
    <script src="../deps/streamlinejs/lib/callbacks/require-stub.js"></script>
    <script src="../deps/narcissus/lib/jsdefs.js"></script>
    <script src="../deps/narcissus/lib/jslex.js"></script>
    <script src="../deps/narcissus/lib/jsparse.js"></script>
    <script src="../deps/narcissus/lib/jsdecomp.js"></script>
    <script src="../deps/streamlinejs/lib/version.js"></script>
    <script src="../deps/streamlinejs/lib/util/source-map.js"></script>
    <script src="../deps/streamlinejs/lib/callbacks/format.js"></script>
    <script src="../deps/streamlinejs/lib/callbacks/transform.js"></script>
    <script src="../deps/streamlinejs/lib/util/future.js"></script>
    <script src="../deps/streamlinejs/lib/callbacks/runtime.js"></script>
    <script src="../deps/streamlinejs/lib/callbacks/builtins.js"></script>
    <script src="../lib/hypnotic.min.js"></script>
    <script src="sleep.js"></script>
    <script src="demo.js"></script>
    <style>
    </style>
  </head>
  <body>
    <a href="https://github.com/coolwanglu/hypnotic"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
    <div class="container">
      <div class="jumbotron">
        <div class="pull-right">
          <iframe
            src="http://ghbtns.com/github-btn.html?user=coolwanglu&repo=hypnotic&type=watch&count=true&size=large"
          allowtransparency="true" frameborder="0" scrolling="0" width="170" height="30"></iframe>
        </div>
        <h1><strong>Hypnotic</strong> <small>Let JavaScript <em>Sleep()</em>!</small></h1>
        <h3>by <a target="_blank" href="http://coolwanglu.github.io/">Lu Wang</a></h3>
        <br/>
        <p>We all knew that <a target="_blank" href="//www.google.com/search?q=why+is+there+no+sleep+function+in+javascript">
          there is no <em>sleep()</em> in JavaScript</a>.&nbsp;&nbsp;
          <button type="button" class="btn btn-default btn-xs" data-toggle="collapse" data-target="#did-you-mean">
            <span class="glyphicon glyphicon-arrow-left"></span> Wait, that's not true!
          </button>
        </p>
        <div class="panel panel-default small collapse" id="did-you-mean">
          <div class="panel-body">
            <div class="row">
              <div class="col-md-4">
                <h4>Let me guess... Did you mean:</h4>
                <ul class="nav nav-pills nav-stacked small narrow" role="navigation">
                  <li class="active"><a href="#busy-wait" data-toggle="tab">while(Date.now() < stop){}</a></li>
                  <li><a href="#settimeout" data-toggle="tab">setTimeout(callback, delay);</a></li>
                  <li><a href="#promise" data-toggle="tab">Promises</a></li>
                  <li><a href="#transformation" data-toggle="tab">Transformation</a></li>
                  <li><a href="#extensions" data-toggle="tab">Extensions of Interpreters</a></li>
                  <li><a href="#others" data-toggle="tab">Others</a></li>
                </ul>
              </div>
              <div class="col-md-8">
                <div class="well well-lg tab-content"> 
                  <div id="busy-wait" class="tab-pane fade in active">
                    <p>Although you can waste some time with a loop, the
                    JavaScript interpreter is actually frozen such that you
                    cannot receive any events, and that's why this is called 
                    <a href="http://en.wikipedia.org/wiki/Busy_waiting">busy-waiting</a>.
                    The following reaction game won't work with a busy-waiting
                    <em>sleep()</em>.
                    </p>
                    <p>On the other hand, <strong>Hyponotic</strong> puts the
                    JavaScript interpreter into sleep, deep deep sleep!</p>
                  </div>
                  <div id="settimeout" class="tab-pane fade">
                    <p><em>setTimeout()</em> lets you delay the execution of some function 
                    <em>in another context</em>. Your current context has to
                    exit. This is very annoying when you need to define logic
                    about timing in your program. Consider how you can
                    implement the following reaction game with
                    <em>setTimeout()</em>.
                    </p>
                    <p>
                    On the other hand, with sync <em>sleep()</em> powered by
                    <strong>Hypnotic</strong>, life becomes much easier now!
                    </p>
                  </div>
                  <div id="promise" class="tab-pane fade">
                    <p><a href="//www.google.com/search?q=promise+pattern">Promise pattern</a> saves us from nested brackets,
                    it lets us write asynchronous code in an intuitive way. But still you need to define lots of callback functions,
                    with extra efforts to maintain states. How about writing a loop with the promise pattern? Sounds easy?
                    </p>
                    <p>
                    On the other hand, <strong>Hypnotic</strong> brings the missing <em>sleep()</em> for you! You want delays in loops, branches and even with exception handling? Piece of cake!
                    </p>
                  </div>
                  <div id="transformation" class="tab-pane fade">
                    <p>You've been playing around with <a href="https://github.com/Sage/streamlinejs">streamline.js</a>,
                    <a href="https://github.com/BYVoid/continuation">continuation.js</a> or
                    <a href="https://github.com/JeffreyZhao/wind">Wind.js</a>, haven't you?
                    These semi-auto <a href="http://en.wikipedia.org/wiki/Continuation-passing_style">CPS</a> transformers give
                    us brand new experience writing asynchronous functions in a synchronous fashion. They are almost the ultimate
                    solution except for that we have to mark all the asynchronous functions in some way &mdash; 
                    this cannot be done by the transformers,
                    you won't know if a function is synchronous or not until 
                    it is actually resolved in the runtime.
                    </p>
                    <p>
                      Try to rename or override <em>sleep()</em> in the below and see if <strong>Hypnotic</strong> still works!
                    </p>
                  </div>
                  <div id="extensions" class="tab-pane fade">
                    <p>Yes, we do have native <em>sleep()</em> with <a href="https://github.com/laverdet/node-fibers">fibers</a>,
                    <a href="https://developer.mozilla.org/en/docs/Rhino/Shell">Rhino</a>, 
                    or even <a href="http://sejq.blogspot.hk/2008/12/two-javascript-synchronous-sleep.html">XPCOM</a>, 
                    but they rely on special extensions for interpreters, which are not a general solutions.
                    </p>
                    <p>
                    On the other hand, <strong>Hypnotic</strong> is written in
                    pure JavaScript. Did you know that you can run <code>print(sleep.toSource());</code>?
                    </p>
                  </div>
                  <div id="others" class="tab-pane fade">
                    <p>Oh Great! You have even more great ideas.</p>
                    <p>Would you leave some comments below and let us know?<p>
                    <p>Thank you!</p>
                  </div>
                </div><!-- well -->
              </div> <!-- col -->
            </div> <!-- row -->
          </div>
        </div> <!-- panel -->
        <p>But those days are finally over!</p>
        <p><strong>Hypnotic</strong> lets you write <em>synchronous sleep()</em> without freezing your browser.</p>
        <p>Try it below and enjoy! :)<p>
      </div>
      <ul class="nav nav-tabs nav-justified" role="navigation">
        <li><a href="#background" data-toggle="tab">Background</a></li>
        <li class="active"><a href="#play" data-toggle="tab" id="link-play">Play!</a></li>
        <li><a href="#how-did-it-work" data-toggle="tab">How did it work?</a></li>
        <li><a href="#motivation" data-toggle="tab">Should I use <strong>Hypnotic</strong>?&nbsp;&nbsp;<span class="label label-warning">new!</span></a></li>
      </ul>
      <br>
      <div class="tab-content">
        <div class="tab-pane fade jumbotron" id="background">
          <p>JavaScript is a single-threaded event-driven language. It is a kind of feature with which we rarely
          need to worry about locking, re-entrancy, atomic operations or other thread safety issues.</p>
          <p>But an immediate side effect is that in JavaScript there is no <em>sleep()</em>, which exists in most
          other languages. In JavaScript we can never suspend the current thread as there is no extra thread to wake us up!</p>
          <p> Although busy-waiting and <em>setTimeout()</em> might help in some situations, 
          it may be very annoying writing in the asynchronous fashion, especially when writing timing logics.  </p>
          <p>Finally those days are over! <small><small class="text-muted">Kind of.</small></small></p>
          <p>Play the reaction game and see how <strong>Hypnotic</strong> could make your life easier!</p>
        </div>
        <div class="tab-pane fade in active" id="play">
          <div class="row">
            <div class="col-md-6">
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h3 class="panel-title">Play around with the source code and hit <strong>Execute!</strong>  <span class="glyphicon glyphicon-arrow-right"></span></h3>
                </div>
                <div class="panel-body">
                  <div class="alert alert-warning">
                    Only Firefox is supported right now. <a href="#why-firefox-only" data-toggle="collapse"><small class="text-muted">why?</small></a>
                    <div class="collapse" id="why-firefox-only">
                      <strong>Hypnotic</strong> uses some features in the future versions of JavaScript, which are only supported by Firefox currently.
                    </div>
                  </div>
                  <textarea id="source" class="form-control" autocomplete="off" rows="30">
            // Collect mouse events
            var events = [];
            document.addEventListener('mousemove', function(e) {
                events.push(e);
            });
        
            // Wait for mouse movement SYNCHRONOUSLY
            function wait_for_mousemove(timeout) {
                events.length = 0;
                var threshold = Date.now() + timeout;
                while(events.length == 0) {
                    if((timeout > 0) 
                       && (Date.now() >= threshold))
                        return false;
        
                    sleep(10); // does it work?
                               // at least busy-waiting doesn't
                }
                return true;
            }
        
        
            // helpers
            var output_e = document.getElementById('output');
            var print = function(msg) {
                output_e.textContent = msg;
            };
        
        
            // a bunch of blank lines
        
        
        
        
        
        
        
        
        



            /*
             * Does sleep() work in JavaScript?
             * Yes with Hypnotic!
             */
            (function(){
                print('How fast can you react?'); sleep(1500);
        
                print('Let\'s see...'); sleep(1500);

            /* so what? isn't that just busy-wait? let's see... */
        
                print('Hold your mouse...');
                var timeout = 1000 + 2000 * Math.random(); 
                if(wait_for_mousemove(timeout)) {
                    print('Too soon!'); return;
                }
        
            /* wait_for_mousemove() essentially calls sleep(), see above */

                print('Wait for it...');
                var timeout = 2000 + 1000 * Math.random(); 
                if(wait_for_mousemove(timeout)) {
                    print('Too soon!'); return;
                }
        
                print('Move it now!');
                var t = Date.now(); wait_for_mousemove(0);
                print('Time: ' + (Date.now() - t) + 'ms');
            })();
                  </textarea>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <button class="btn btn-primary btn-lg" type="button" id="execute">Execute!</button>
              <br>
              <br>
              <div class="well well-lg"><h2 id="output">&nbsp;</h2></div>
              <a class="pull-right" id="link-try-your-own" href="#">Try your own code</a>
              <div id="try-your-own" class="collapse">
                <h3>Looks interesting?</h3>
                <h4><span class="glyphicon glyphicon-arrow-left"></span> Try your own code with <em>sleep()</em>.</h4>
                  <div class="jumbotron" id="what-is-it-good-for">
                    <h3>What is it good for?</h3>
                    <small>
                      <ul>
                        <li>Write synchronous code in JavaScript.</li>
                        <li>Of course asynchronous code still works.</li>
                        <li><strong>Hypnotic</strong> can be easily extended.<ul><li>How about <a id="load-semaphore-demo" href="#">semaphores?</a></li></ul></li>
                      </ul>
                    </small>
                  </div>
              </div>
            </div>
          </div><!-- row -->
        </div> <!-- .tab-pane#play -->
        <div class="tab-pane fade" id="how-did-it-work">
          <h3>Did <strong>Hypnotic</strong> impress you? Hopefully yes.</h3>
          <br>
          <p class="alert alert-warning">In order not to lose fun, it's highly recommended that you try to figure it out yourself.</p>
          <p>Just think for a few minutes about how you can implement it.</p>
          <p>No idea?  Here are a few <a href="#hints" data-toggle="collapse">hints</a>.</p>
          <div id="hints" class="collapse">
            <ul>
              <li>Try something in the browser console.</li>
              <li>Check the source code of this page.</li>
            </ul>
            <a href="#hints2" data-toggle="collapse">Not helping?</a>
            <div id="hints2" class="collapse">
              <br>
              <ul>
                <li>Run <code>console.log(sleep.toSource());</code> in the browser console.</li>
                <li>And also do that in the source code area in the previous tab.</li>
              </ul>
              <a href="#hints3" data-toggle="collapse">Even more confusing?</a>
              <div id="hints3" class="collapse">
                <br>
                <p>Read the <a
                  href="https://github.com/coolwanglu/hypnotic/wiki"
                  target="_blank">technical details</a> or <a href="#truth" data-toggle="collapse">this spoiler</a>.</p>
                <div id="truth" class="collapse">
                  <div class="well">
                    <h4><strong>Hypnotic</strong> is an async JavaScript
                    interpreter, which is evolved from <a href="https://github.com/mozilla/narcissus" target="_blank">Narcissus</a> 
                    and <a href="https://github.com/Sage/streamlinejs"
                      target="_blank">streamline.js</a>.</h4>
                  </div>
                </div>
                <br>
                <h3 class="alert alert-info">Did you have fun? Don't forget to add a star and leave some comments!</h3>
              </div>
            </div>
          </div>
          <br>
          <br>
        </div>
        <div class="tab-pane fade jumbotron" id="motivation">
          <p>Thank you so much for all your comments! It appears that previously I did not emphasize the purpose of this project,
          and sorry if you were confused. Allow me to explain:
          </p>
          <blockquote>
            <p><strong>Hypnotic</strong> introduces <em>sleep()</em> in JavaScript for those who really need it, 
              but it does not encourage any unnecessary usage of it &mdash; that is why it is called <strong>Hypnotic</strong>!
            </p>
          </blockquote>
          <p>And there is also a <a href="https://github.com/coolwanglu/hypnotic/wiki#is-it-worth-to-introduce-so-much-overhead-only-for-sleep-">longer
            version</a>.</p>
        </div>
      </div> <!-- tabs -->
      <div class="footer">
        <p>© Lu Wang 2013</p>
      </div>
      <br>
      <br>
      <br>
      <!-- disqus -->
      <div id="disqus_thread"></div>
      <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'hypnotic'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div><!-- container -->
  </body>
</html>
